<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ˜Ÿäº‘çœ‹æ¿ Â· æ·±åº¦ç»Ÿè®¡</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    :root {
      --bg-color: #020617; --panel-bg: rgba(15, 23, 42, 0.85); --accent: #38bdf8;
      --text-main: #f1f5f9; --text-dim: #94a3b8; --border: rgba(255, 255, 255, 0.15);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg-color); color: var(--text-main); font-family: 'PingFang SC', sans-serif; height: 100vh; padding: 15px; overflow: hidden; }
    
    .dashboard { display: grid; grid-template-columns: 350px 1fr 350px; grid-template-rows: 150px 1fr; gap: 15px; height: 100%; width: 100%; }
    
    /* å¹´åº¦æ€»ç»“å¡ç‰‡ - é£æ ¼ç»Ÿä¸€ */
    .summary-card {
      grid-column: 1 / -1;
      background: var(--panel-bg); backdrop-filter: blur(15px);
      border: 1px solid var(--accent); border-radius: 20px; padding: 25px 45px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .summary-left h1 { font-size: 1.6rem; color: var(--accent); margin-bottom: 10px; }
    
    /* ä¸‹æ‹‰é€‰æ‹©å™¨æ ·å¼ */
    .year-picker {
      background: #1e293b; color: #ffffff; border: 1px solid var(--accent);
      padding: 6px 15px; border-radius: 8px; font-size: 1rem; cursor: pointer;
    }

    .summary-stats { display: flex; gap: 60px; }
    .stat-box { text-align: center; }
    .stat-box span { font-size: 0.85rem; color: var(--text-dim); display: block; margin-bottom: 5px; }
    .stat-box b { font-size: 2.2rem; color: #fff; text-shadow: 0 0 12px var(--accent); }

    .card { background: var(--panel-bg); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 16px; padding: 18px; display: flex; flex-direction: column; min-height: 0; }
    .side-zone { display: flex; flex-direction: column; gap: 15px; min-height: 0; }
    .chart-container { flex: 1; width: 100%; min-height: 0; }
    
    h2 { font-size: 0.95rem; color: var(--accent); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    h2::before { content: ''; width: 3px; height: 14px; background: var(--accent); }

    .back-link { padding: 10px 25px; background: rgba(56,189,248,0.1); border: 1px solid var(--accent); color: var(--accent); border-radius: 50px; text-decoration: none; font-weight: bold; transition: 0.3s; }
    .back-link:hover { background: var(--accent); color: #fff; }
  </style>
</head>
<body>

<div class="dashboard">
  <div class="summary-card">
    <div class="summary-left">
      <h1>é˜…è¯»å¹´åº¦çºªå®</h1>
      <select id="yearSelect" class="year-picker" onchange="refreshAll()"></select>
    </div>
    <div class="summary-stats">
      <div class="stat-box"><span>ğŸ“š åº“è—æ€»è®¡</span><b id="t-all">0</b></div>
      <div class="stat-box"><span>ğŸ“… é€‰å®šå¹´å®Œè¯»</span><b id="t-year">0</b></div>
      <div class="stat-box"><span>ğŸ‘¤ å…³è”ä½œè€…</span><b id="t-auth">0</b></div>
    </div>
    <a href="theme-nebula.html" class="back-link">è¿”å›å®‡å®™</a>
  </div>

  <div class="side-zone">
    <div class="card" style="flex: 1;">
      <h2>é˜…è¯»æ³¢å½¢ (è¶‹åŠ¿)</h2>
      <div id="timeChart" class="chart-container"></div>
    </div>
  </div>

  <div class="card">
    <h2>å¹´åº¦é˜…è¯»åˆ†å¸ƒ (æœˆä»½ Ã— å›½å®¶)</h2>
    <div id="bubbleChart" class="chart-container"></div>
  </div>

  <div class="side-zone">
    <div class="card" style="flex: 1;">
      <h2>ç»´åº¦å¼•åŠ› (ä¸»é¢˜)</h2>
      <div id="themeChart" class="chart-container"></div>
    </div>
  </div>
</div>

<script>
  const rawData = JSON.parse(localStorage.getItem('nebula_v3_data')) || [];
  let charts = {};

  // å·¥å…·å‡½æ•°ï¼šä» "2023å¹´7æœˆ" æ ¼å¼æå–å¹´ä»½å’Œæœˆä»½
  function parseChineseDate(dateStr) {
    if (!dateStr) return null;
    
    // åŒ¹é… "2023å¹´7æœˆ" æˆ– "2023å¹´07æœˆ" æ ¼å¼
    const match = dateStr.match(/(\d{4})å¹´(\d{1,2})æœˆ/);
    if (match) {
      const year = match[1];
      const month = match[2].padStart(2, '0'); // è¡¥é›¶ï¼Œå¦‚ 7 -> 07
      return {
        year: year,
        month: month,
        yearMonth: `${year}-${month}` // æ ‡å‡†æ ¼å¼
      };
    }
    
    // å¦‚æœå·²ç»æ˜¯ YYYY-MM æ ¼å¼
    if (dateStr.match(/^\d{4}-\d{2}$/)) {
      const [year, month] = dateStr.split('-');
      return {
        year: year,
        month: month,
        yearMonth: dateStr
      };
    }
    
    return null;
  }

  // 1. è‡ªåŠ¨è¯†åˆ«æ•°æ®ä¸­çš„å¹´åº¦å¹¶å¡«å……é€‰æ‹©å™¨
  function initYearSelector() {
    console.log('åˆå§‹åŒ–å¹´ä»½é€‰æ‹©å™¨ï¼Œæ•°æ®æ€»é‡:', rawData.length);
    
    // æå–æ‰€æœ‰æœ‰æ•ˆçš„é˜…è¯»å¹´ä»½
    const yearsSet = new Set();
    rawData.forEach(d => {
      if (d.readMonth) {
        const parsed = parseChineseDate(d.readMonth);
        if (parsed) {
          console.log('è§£ææ—¥æœŸ:', d.readMonth, '->', parsed);
          yearsSet.add(parsed.year);
        } else {
          console.log('æ— æ³•è§£æçš„æ—¥æœŸæ ¼å¼:', d.readMonth);
        }
      }
    });
    
    // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
    let years = Array.from(yearsSet);
    if (years.length === 0) {
      const currentYear = new Date().getFullYear().toString();
      console.log('æœªæ‰¾åˆ°é˜…è¯»å¹´ä»½ï¼Œä½¿ç”¨å½“å‰å¹´ä»½:', currentYear);
      years.push(currentYear);
    }
    
    // é™åºæ’åº
    years.sort((a, b) => parseInt(b) - parseInt(a));
    console.log('å¯é€‰çš„å¹´ä»½åˆ—è¡¨:', years);
    
    const select = document.getElementById('yearSelect');
    select.innerHTML = '';
    
    // æ·»åŠ é€‰é¡¹
    years.forEach(y => {
      const opt = document.createElement('option');
      opt.value = y;
      opt.text = y + ' å¹´åº¦';
      select.appendChild(opt);
    });
    
    // è®¾ç½®é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
    if (years.length > 0) {
      select.value = years[0];
    }
  }

  // 2. æ ¸å¿ƒï¼šå¹´åº¦æ°”æ³¡å›¾ (X:æœˆä»½, Y:å›½å®¶)
  function initBubbleChart() {
    const dom = document.getElementById('bubbleChart');
    if (charts.bubble) {
      charts.bubble.dispose();
    }
    
    const chart = echarts.init(dom);
    const selectedYear = document.getElementById('yearSelect').value;
    
    console.log(`æ­£åœ¨ç”Ÿæˆ ${selectedYear} å¹´çš„æ°”æ³¡å›¾...`);
    
    // æå–å½“å‰å¹´åº¦çš„æ•°æ®
    const yearData = rawData.filter(d => {
      if (!d.readMonth) return false;
      const parsed = parseChineseDate(d.readMonth);
      return parsed && parsed.year === selectedYear;
    });
    
    console.log(`${selectedYear} å¹´çš„é˜…è¯»è®°å½•æ•°:`, yearData.length);
    
    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
    if (yearData.length === 0) {
      console.warn(`${selectedYear} å¹´æ²¡æœ‰é˜…è¯»æ•°æ®`);
      chart.setOption({
        title: {
          text: `${selectedYear} å¹´æš‚æ— é˜…è¯»æ•°æ®`,
          left: 'center',
          top: 'center',
          textStyle: {
            color: '#94a3b8',
            fontSize: 16,
            fontWeight: 'normal'
          }
        },
        graphic: {
          type: 'text',
          left: 'center',
          top: 'middle',
          style: {
            text: 'è¯·é€‰æ‹©å…¶ä»–å¹´ä»½',
            fontSize: 14,
            fill: '#64748b'
          }
        }
      });
      charts.bubble = chart;
      return;
    }
    
    // æå–æ‰€æœ‰å›½å®¶/åœ°åŒº
    const countries = [...new Set(yearData.map(d => d.country || 'å…¶ä»–'))];
    const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
    
    console.log('æ¶‰åŠå›½å®¶/åœ°åŒº:', countries);
    console.log('æ¶‰åŠæœˆä»½æ•°:', months.length);
    
    // ç»Ÿè®¡æ•°æ®: [æœˆä»½ç´¢å¼•, å›½å®¶ç´¢å¼•, æ•°é‡]
    const bubbleMap = {};
    yearData.forEach(d => {
      if (!d.readMonth) return;
      
      const parsed = parseChineseDate(d.readMonth);
      if (!parsed) return;
      
      const month = parsed.month;
      const country = d.country || 'å…¶ä»–';
      const key = `${month}-${country}`;
      
      bubbleMap[key] = (bubbleMap[key] || 0) + 1;
    });
    
    console.log('æ°”æ³¡å›¾ç»Ÿè®¡æ•°æ®:', bubbleMap);
    
    // å‡†å¤‡æœ€ç»ˆæ•°æ®
    const finalData = [];
    Object.keys(bubbleMap).forEach(key => {
      const [month, country] = key.split('-');
      const count = bubbleMap[key];
      
      const monthIndex = months.indexOf(month);
      const countryIndex = countries.indexOf(country);
      
      if (monthIndex !== -1 && countryIndex !== -1) {
        finalData.push([monthIndex, countryIndex, count]);
      }
    });
    
    console.log('æœ€ç»ˆæ°”æ³¡æ•°æ®:', finalData);
    
    // è®¾ç½®å›¾è¡¨é€‰é¡¹
    const option = {
      grid: {
        left: '12%',
        right: '5%',
        top: '10%',
        bottom: '12%',
        containLabel: true
      },
      xAxis: {
        type: 'category',
        data: months.map(m => m + 'æœˆ'),
        axisLabel: {
          color: '#94a3b8',
          fontSize: 12
        },
        axisLine: {
          lineStyle: {
            color: 'rgba(255, 255, 255, 0.1)'
          }
        },
        splitLine: {
          show: true,
          lineStyle: {
            color: 'rgba(255, 255, 255, 0.05)'
          }
        },
        name: 'æœˆä»½',
        nameTextStyle: {
          color: '#94a3b8',
          fontSize: 12
        }
      },
      yAxis: {
        type: 'category',
        data: countries,
        axisLabel: {
          color: '#f1f5f9',
          fontSize: 12
        },
        axisLine: {
          lineStyle: {
            color: 'rgba(255, 255, 255, 0.1)'
          }
        },
        splitLine: {
          show: true,
          lineStyle: {
            color: 'rgba(255, 255, 255, 0.05)'
          }
        },
        name: 'å›½å®¶/åœ°åŒº',
        nameTextStyle: {
          color: '#94a3b8',
          fontSize: 12
        }
      },
      tooltip: {
        trigger: 'item',
        backgroundColor: 'rgba(15, 23, 42, 0.9)',
        borderColor: '#38bdf8',
        textStyle: {
          color: '#fff'
        },
        formatter: function(params) {
          const data = params.data;
          if (!data) return '';
          const month = months[data[0]] + 'æœˆ';
          const country = countries[data[1]];
          const count = data[2];
          return `<div style="font-size: 12px;">
                    <div>${country}</div>
                    <div>${month}</div>
                    <div style="color: #38bdf8; font-weight: bold; margin-top: 4px;">${count} æœ¬</div>
                  </div>`;
        }
      },
      series: [{
        type: 'scatter',
        data: finalData,
        symbolSize: function(val) {
          // æ ¹æ®æ•°é‡è®¡ç®—æ°”æ³¡å¤§å°ï¼Œç¡®ä¿æœ€å°å¯è§
          const size = Math.sqrt(val[2]) * 25;
          return Math.max(size, 25); // æœ€å°25åƒç´ 
        },
        itemStyle: {
          color: new echarts.graphic.RadialGradient(0.4, 0.3, 1, [
            { offset: 0, color: '#38bdf8' },
            { offset: 0.7, color: '#2563eb' },
            { offset: 1, color: '#1d4ed8' }
          ]),
          opacity: 0.8,
          borderColor: '#fff',
          borderWidth: 1,
          shadowBlur: 10,
          shadowColor: 'rgba(56, 189, 248, 0.5)'
        },
        emphasis: {
          itemStyle: {
            opacity: 1,
            shadowBlur: 15,
            shadowColor: 'rgba(56, 189, 248, 0.8)'
          }
        },
        label: {
          show: true,
          formatter: function(params) {
            return params.data[2];
          },
          color: '#fff',
          fontSize: 10,
          fontWeight: 'bold'
        }
      }],
      backgroundColor: 'transparent'
    };
    
    chart.setOption(option);
    charts.bubble = chart;
    
    console.log('æ°”æ³¡å›¾ç”Ÿæˆå®Œæˆ');
  }

  // 3. ä¿®å¤æ—¶é—´åºåˆ—å›¾è¡¨
  function initTimeChart() {
    const chart = echarts.init(document.getElementById('timeChart'));
    
    // ç»Ÿè®¡æ¯æœˆé˜…è¯»æ•°é‡
    const monthsMap = {};
    rawData.forEach(d => {
      if (d.readMonth) {
        const parsed = parseChineseDate(d.readMonth);
        if (parsed) {
          const key = parsed.yearMonth; // ä½¿ç”¨æ ‡å‡†æ ¼å¼ YYYY-MM
          monthsMap[key] = (monthsMap[key] || 0) + 1;
        }
      }
    });
    
    // æŒ‰æ—¶é—´æ’åº
    const sortedKeys = Object.keys(monthsMap).sort();
    const sortedValues = sortedKeys.map(k => monthsMap[k]);
    
    // è½¬æ¢æ˜¾ç¤ºæ ¼å¼ï¼šYYYY-MM -> YYYYå¹´MMæœˆ
    const displayLabels = sortedKeys.map(key => {
      const [year, month] = key.split('-');
      return `${year}å¹´${parseInt(month)}æœˆ`;
    });
    
    console.log('æ—¶é—´åºåˆ—æ•°æ®:', sortedKeys, sortedValues);
    
    chart.setOption({
      tooltip: {
        trigger: 'axis',
        backgroundColor: 'rgba(15, 23, 42, 0.9)',
        borderColor: '#38bdf8',
        textStyle: { color: '#fff' },
        formatter: function(params) {
          const data = params[0];
          const index = data.dataIndex;
          return `${displayLabels[index]}<br/>é˜…è¯»é‡: ${data.value} æœ¬`;
        }
      },
      grid: {
        left: '3%',
        right: '4%',
        top: '10%',
        bottom: '10%',
        containLabel: true
      },
      xAxis: {
        type: 'category',
        data: displayLabels,
        axisLabel: {
          color: '#64748b',
          fontSize: 11,
          rotate: 45
        },
        axisLine: {
          lineStyle: {
            color: 'rgba(255, 255, 255, 0.1)'
          }
        }
      },
      yAxis: {
        type: 'value',
        splitLine: {
          lineStyle: {
            color: 'rgba(255, 255, 255, 0.05)'
          }
        },
        axisLabel: {
          color: '#64748b'
        },
        name: 'é˜…è¯»é‡',
        nameTextStyle: {
          color: '#94a3b8'
        }
      },
      series: [{
        data: sortedValues,
        type: 'line',
        smooth: true,
        symbol: 'circle',
        symbolSize: 6,
        itemStyle: {
          color: '#38bdf8'
        },
        lineStyle: {
          width: 3,
          shadowBlur: 10,
          shadowColor: 'rgba(56, 189, 248, 0.5)'
        },
        areaStyle: {
          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
            { offset: 0, color: 'rgba(56, 189, 248, 0.5)' },
            { offset: 1, color: 'transparent' }
          ])
        },
        emphasis: {
          itemStyle: {
            color: '#fff',
            borderColor: '#38bdf8',
            borderWidth: 2
          }
        }
      }]
    });
    
    charts.time = chart;
  }

  // 4. è¿˜åŸç»´åº¦å¼•åŠ›æ ¼å¼
  function initThemeChart() {
    const chart = echarts.init(document.getElementById('themeChart'));
    const themes = {};
    
    // ç»Ÿè®¡ä¸»é¢˜æ•°é‡
    rawData.forEach(d => {
      if (d.theme) {
        // åˆ†å‰²ä¸»é¢˜ï¼ˆæ”¯æŒå¤šç§åˆ†éš”ç¬¦ï¼‰
        const themeList = d.theme.split(/[\/ï¼,ï¼Œã€]/);
        themeList.forEach(t => {
          const trimmed = t.trim();
          if (trimmed) {
            themes[trimmed] = (themes[trimmed] || 0) + 1;
          }
        });
      }
    });
    
    // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
    const themeArray = Object.entries(themes).map(([name, value]) => ({ name, value }));
    themeArray.sort((a, b) => b.value - a.value);
    
    // å–å‰8ä¸ªä¸»é¢˜
    const topThemes = themeArray.slice(0, 8);
    
    console.log('ä¸»é¢˜æ•°æ®:', topThemes);
    
    // ç”Ÿæˆé¢œè‰²
    const colors = [
      '#38bdf8', '#3b82f6', '#6366f1', '#8b5cf6',
      '#a855f7', '#d946ef', '#ec4899', '#f43f5e'
    ];
    
    chart.setOption({
      tooltip: {
        trigger: 'item',
        backgroundColor: 'rgba(15, 23, 42, 0.9)',
        borderColor: '#38bdf8',
        textStyle: { color: '#fff' },
        formatter: '{a} <br/>{b}: {c} ({d}%)'
      },
      legend: {
        type: 'scroll',
        orient: 'vertical',
        right: 10,
        top: 'center',
        textStyle: {
          color: '#94a3b8',
          fontSize: 11
        },
        pageTextStyle: {
          color: '#94a3b8'
        }
      },
      series: [{
        name: 'ä¸»é¢˜åˆ†å¸ƒ',
        type: 'pie',
        radius: ['20%', '75%'],
        center: ['35%', '50%'],
        roseType: 'radius',
        itemStyle: {
          borderRadius: 8,
          borderColor: 'var(--bg-color)',
          borderWidth: 2
        },
        label: {
          color: '#94a3b8',
          fontSize: 11,
          formatter: '{b}: {c}'
        },
        labelLine: {
          lineStyle: {
            color: 'rgba(255, 255, 255, 0.2)'
          }
        },
        data: topThemes.map((item, index) => ({
          ...item,
          itemStyle: {
            color: colors[index % colors.length]
          }
        })),
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowOffsetX: 0,
            shadowColor: 'rgba(0, 0, 0, 0.5)'
          }
        }
      }]
    });
    
    charts.theme = chart;
  }

  // 5. åˆ·æ–°æ‰€æœ‰æ•°æ®å’Œå›¾è¡¨
  function refreshAll() {
    try {
      const selectedYear = document.getElementById('yearSelect').value;
      console.log('åˆ·æ–°æ•°æ®ï¼Œé€‰ä¸­å¹´ä»½:', selectedYear);
      
      // æ›´æ–°ç»Ÿè®¡æ•°æ®
      const totalBooks = rawData.length;
      const yearBooks = rawData.filter(d => {
        if (!d.readMonth) return false;
        const parsed = parseChineseDate(d.readMonth);
        return parsed && parsed.year === selectedYear;
      }).length;
      
      // è®¡ç®—ä¸é‡å¤ä½œè€…æ•°
      const authorsSet = new Set();
      rawData.forEach(d => {
        if (d.author && d.author.trim()) {
          authorsSet.add(d.author.trim());
        }
      });
      const uniqueAuthors = authorsSet.size;
      
      // æ›´æ–°DOM
      document.getElementById('t-all').innerText = totalBooks;
      document.getElementById('t-year').innerText = yearBooks;
      document.getElementById('t-auth').innerText = uniqueAuthors;
      
      console.log('ç»Ÿè®¡æ›´æ–°å®Œæˆ:', {
        æ€»è—ä¹¦: totalBooks,
        å¹´åº¦é˜…è¯»: yearBooks,
        ä¸é‡å¤ä½œè€…: uniqueAuthors
      });
      
      // é‡æ–°åˆå§‹åŒ–æ°”æ³¡å›¾
      initBubbleChart();
      
    } catch (error) {
      console.error('åˆ·æ–°æ•°æ®æ—¶å‡ºé”™:', error);
    }
  }

  // 6. çª—å£å¤§å°è°ƒæ•´å¤„ç†
  function handleResize() {
    Object.values(charts).forEach(chart => {
      if (chart && chart.resize) {
        try {
          chart.resize();
        } catch (e) {
          console.error('è°ƒæ•´å›¾è¡¨å¤§å°æ—¶å‡ºé”™:', e);
        }
      }
    });
  }

  // 7. é¡µé¢åŠ è½½åˆå§‹åŒ–
  window.onload = function() {
    try {
      console.log('é¡µé¢åˆå§‹åŒ–å¼€å§‹...');
      console.log('åŸå§‹æ•°æ®é‡:', rawData.length);
      
      if (rawData.length > 0) {
        console.log('ç¬¬ä¸€æ¡æ•°æ®æ ·æœ¬:', rawData[0]);
        // æµ‹è¯•æ—¥æœŸè§£æ
        const testDate = rawData[0].readMonth;
        console.log('æµ‹è¯•æ—¥æœŸè§£æ:', testDate, '->', parseChineseDate(testDate));
      }
      
      // åˆå§‹åŒ–å¹´ä»½é€‰æ‹©å™¨
      initYearSelector();
      
      // åˆå§‹åŒ–å›¾è¡¨
      initTimeChart();
      initThemeChart();
      initBubbleChart();
      
      // æ›´æ–°ç»Ÿè®¡æ•°æ®
      refreshAll();
      
      // ç»‘å®šçª—å£è°ƒæ•´äº‹ä»¶
      window.addEventListener('resize', handleResize);
      
      console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
      
    } catch (error) {
      console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
      
      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(239, 68, 68, 0.9);
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 1000;
        text-align: center;
        max-width: 80%;
      `;
      errorDiv.innerHTML = `
        <h3>åˆå§‹åŒ–å¤±è´¥</h3>
        <p>${error.message}</p>
        <p>è¯·æ£€æŸ¥æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯</p>
      `;
      document.body.appendChild(errorDiv);
    }
  };
</script>
</body>
</html>