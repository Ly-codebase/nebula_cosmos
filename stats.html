<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ˜Ÿäº‘çœ‹æ¿ Â· æ·±åº¦ç»Ÿè®¡</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    :root {
      --bg-color: #020617; --panel-bg: rgba(15, 23, 42, 0.85); --accent: #38bdf8;
      --text-main: #f1f5f9; --text-dim: #94a3b8; --border: rgba(255, 255, 255, 0.15);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg-color); color: var(--text-main); font-family: 'PingFang SC', sans-serif; height: 100vh; padding: 15px; overflow: hidden; }
    
    .dashboard { display: grid; grid-template-columns: 350px 1fr 350px; grid-template-rows: 150px 1fr; gap: 15px; height: 100%; width: 100%; }
    
    .summary-card {
      grid-column: 1 / -1;
      background: var(--panel-bg); backdrop-filter: blur(15px);
      border: 1px solid var(--accent); border-radius: 20px; padding: 25px 45px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .summary-left h1 { font-size: 1.6rem; color: var(--accent); margin-bottom: 10px; }
    
    .year-picker {
      background: #1e293b; color: #ffffff; border: 1px solid var(--accent);
      padding: 6px 15px; border-radius: 8px; font-size: 1rem; cursor: pointer;
    }

    .summary-stats { display: flex; gap: 60px; }
    .stat-box { text-align: center; }
    .stat-box span { font-size: 0.85rem; color: var(--text-dim); display: block; margin-bottom: 5px; }
    .stat-box b { font-size: 2.2rem; color: #fff; text-shadow: 0 0 12px var(--accent); }

    .card { background: var(--panel-bg); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 16px; padding: 18px; display: flex; flex-direction: column; min-height: 0; }
    .side-zone { display: flex; flex-direction: column; gap: 15px; min-height: 0; }
    .chart-container { flex: 1; width: 100%; min-height: 0; }
    
    h2 { font-size: 0.95rem; color: var(--accent); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    h2::before { content: ''; width: 3px; height: 14px; background: var(--accent); }

    .back-link { padding: 10px 25px; background: rgba(56,189,248,0.1); border: 1px solid var(--accent); color: var(--accent); border-radius: 50px; text-decoration: none; font-weight: bold; transition: 0.3s; }
    .back-link:hover { background: var(--accent); color: #fff; }
  </style>
</head>
<body>

<div class="dashboard">
  <div class="summary-card">
    <div class="summary-left">
      <h1>é˜…è¯»å¹´åº¦çºªå®</h1>
      <select id="yearSelect" class="year-picker" onchange="refreshAll()"></select>
    </div>
    <div class="summary-stats">
      <div class="stat-box"><span>ğŸ“š åº“è—æ€»è®¡</span><b id="t-all">0</b></div>
      <div class="stat-box"><span>ğŸ“… é€‰å®šå¹´å®Œè¯»</span><b id="t-year">0</b></div>
      <div class="stat-box"><span>ğŸ‘¤ å…³è”ä½œè€…</span><b id="t-auth">0</b></div>
    </div>
    <a href="theme-nebula.html" class="back-link">è¿”å›å®‡å®™</a>
  </div>

  <div class="side-zone">
    <div class="card" style="flex: 1;">
      <h2>é˜…è¯»æ³¢å½¢ (è¶‹åŠ¿)</h2>
      <div id="timeChart" class="chart-container"></div>
    </div>
  </div>

  <div class="card">
    <h2>å¹´åº¦é˜…è¯»åˆ†å¸ƒ (æœˆä»½ Ã— å›½å®¶)</h2>
    <div id="bubbleChart" class="chart-container"></div>
  </div>

  <div class="side-zone">
    <div class="card" style="flex: 1;">
      <h2>ç»´åº¦å¼•åŠ› (ä¸»é¢˜)</h2>
      <div id="themeChart" class="chart-container"></div>
    </div>
  </div>
</div>

<script>
  const rawData = JSON.parse(localStorage.getItem('nebula_v3_data')) || [];
  let charts = {};

  // æ—¥æœŸè§£æå‡½æ•°
  function parseChineseDate(dateStr) {
    if (!dateStr) return null;
    const match = dateStr.match(/(\d{4})å¹´(\d{1,2})æœˆ/);
    if (match) {
      const year = match[1];
      const month = match[2].padStart(2, '0');
      return { year, month, yearMonth: `${year}-${month}` };
    }
    if (dateStr.match(/^\d{4}-\d{2}$/)) {
      const [year, month] = dateStr.split('-');
      return { year, month, yearMonth: dateStr };
    }
    return null;
  }

  // åˆå§‹åŒ–å¹´ä»½é€‰æ‹©å™¨
  function initYearSelector() {
    const yearsSet = new Set();
    rawData.forEach(d => {
      if (d.readMonth) {
        const parsed = parseChineseDate(d.readMonth);
        if (parsed) yearsSet.add(parsed.year);
      }
    });
    
    let years = Array.from(yearsSet);
    if (years.length === 0) {
      years.push(new Date().getFullYear().toString());
    }
    
    years.sort((a, b) => parseInt(b) - parseInt(a));
    
    const select = document.getElementById('yearSelect');
    select.innerHTML = '';
    years.forEach(y => {
      const opt = document.createElement('option');
      opt.value = y;
      opt.text = y + ' å¹´åº¦';
      select.appendChild(opt);
    });
    
    if (years.length > 0) select.value = years[0];
  }

  // åˆå§‹åŒ–æ°”æ³¡å›¾
  function initBubbleChart() {
    const dom = document.getElementById('bubbleChart');
    if (charts.bubble) charts.bubble.dispose();
    
    const chart = echarts.init(dom);
    const selectedYear = document.getElementById('yearSelect').value;
    
    const yearData = rawData.filter(d => {
      if (!d.readMonth) return false;
      const parsed = parseChineseDate(d.readMonth);
      return parsed && parsed.year === selectedYear;
    });
    
    if (yearData.length === 0) {
      chart.setOption({
        title: {
          text: `${selectedYear} å¹´æš‚æ— é˜…è¯»æ•°æ®`,
          left: 'center',
          top: 'center',
          textStyle: { color: '#94a3b8', fontSize: 16 }
        }
      });
      charts.bubble = chart;
      return;
    }
    
    const countries = [...new Set(yearData.map(d => d.country || 'å…¶ä»–'))];
    const months = ['01','02','03','04','05','06','07','08','09','10','11','12'];
    
    const bubbleMap = {};
    yearData.forEach(d => {
      const parsed = parseChineseDate(d.readMonth);
      if (!parsed) return;
      const month = parsed.month;
      const country = d.country || 'å…¶ä»–';
      const key = `${month}-${country}`;
      bubbleMap[key] = (bubbleMap[key] || 0) + 1;
    });
    
    const finalData = [];
    Object.keys(bubbleMap).forEach(key => {
      const [month, country] = key.split('-');
      const count = bubbleMap[key];
      const monthIndex = months.indexOf(month);
      const countryIndex = countries.indexOf(country);
      if (monthIndex !== -1 && countryIndex !== -1) {
        finalData.push([monthIndex, countryIndex, count]);
      }
    });
    
    chart.setOption({
      grid: { left: '12%', right: '5%', top: '10%', bottom: '12%' },
      xAxis: {
        type: 'category',
        data: months.map(m => m + 'æœˆ'),
        axisLabel: { color: '#94a3b8' },
        splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } }
      },
      yAxis: {
        type: 'category',
        data: countries,
        axisLabel: { color: '#f1f5f9' },
        splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } }
      },
      tooltip: {
        trigger: 'item',
        backgroundColor: 'rgba(15,23,42,0.9)',
        borderColor: '#38bdf8',
        textStyle: { color: '#fff' }
      },
      series: [{
        type: 'scatter',
        data: finalData,
        symbolSize: (val) => Math.max(Math.sqrt(val[2]) * 25, 25),
        itemStyle: {
          color: new echarts.graphic.RadialGradient(0.4, 0.3, 1, [
            { offset: 0, color: '#38bdf8' },
            { offset: 1, color: '#1d4ed8' }
          ]),
          borderColor: '#fff',
          borderWidth: 1
        },
        label: {
          show: true,
          formatter: (p) => p.data[2],
          color: '#fff',
          fontSize: 10
        }
      }]
    });
    
    charts.bubble = chart;
  }

  // åˆå§‹åŒ–æ—¶é—´å›¾è¡¨
  function initTimeChart() {
    const chart = echarts.init(document.getElementById('timeChart'));
    
    const monthsMap = {};
    rawData.forEach(d => {
      if (d.readMonth) {
        const parsed = parseChineseDate(d.readMonth);
        if (parsed) {
          monthsMap[parsed.yearMonth] = (monthsMap[parsed.yearMonth] || 0) + 1;
        }
      }
    });
    
    const sortedKeys = Object.keys(monthsMap).sort();
    
    chart.setOption({
      tooltip: {
        trigger: 'axis',
        backgroundColor: 'rgba(15,23,42,0.9)',
        borderColor: '#38bdf8',
        textStyle: { color: '#fff' }
      },
      xAxis: {
        type: 'category',
        data: sortedKeys.map(key => {
          const [year, month] = key.split('-');
          return `${year}å¹´${parseInt(month)}æœˆ`;
        }),
        axisLabel: { color: '#64748b', rotate: 45 }
      },
      yAxis: {
        type: 'value',
        splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } },
        axisLabel: { color: '#64748b' }
      },
      series: [{
        data: sortedKeys.map(k => monthsMap[k]),
        type: 'line',
        smooth: true,
        itemStyle: { color: '#38bdf8' },
        areaStyle: {
          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
            { offset: 0, color: 'rgba(56,189,248,0.3)' },
            { offset: 1, color: 'transparent' }
          ])
        }
      }]
    });
    
    charts.time = chart;
  }

  // åˆå§‹åŒ–ä¸»é¢˜å›¾è¡¨
  function initThemeChart() {
    const chart = echarts.init(document.getElementById('themeChart'));
    const themes = {};
    
    rawData.forEach(d => {
      if (d.theme) {
        d.theme.split(/[\/ï¼,ï¼Œã€]/).forEach(t => {
          const trimmed = t.trim();
          if (trimmed) themes[trimmed] = (themes[trimmed] || 0) + 1;
        });
      }
    });
    
    const data = Object.entries(themes).map(([name, value]) => ({ name, value }))
      .sort((a,b) => b.value - a.value).slice(0, 8);
    
    chart.setOption({
      series: [{
        type: 'pie',
        radius: ['20%', '75%'],
        roseType: 'radius',
        data: data,
        label: { color: '#94a3b8', formatter: '{b}' }
      }]
    });
    
    charts.theme = chart;
  }

  // åˆ·æ–°æ‰€æœ‰æ•°æ®
  function refreshAll() {
    const y = document.getElementById('yearSelect').value;
    
    document.getElementById('t-all').innerText = rawData.length;
    document.getElementById('t-year').innerText = rawData.filter(d => {
      if (!d.readMonth) return false;
      const parsed = parseChineseDate(d.readMonth);
      return parsed && parsed.year === y;
    }).length;
    document.getElementById('t-auth').innerText = new Set(rawData.map(d => d.author)).size;
    
    initBubbleChart();
  }

  // é¡µé¢åˆå§‹åŒ–
  window.onload = () => {
    initYearSelector();
    initTimeChart();
    initThemeChart();
    refreshAll();
    window.onresize = () => Object.values(charts).forEach(c => c.resize());
  };
</script>
</body>
</html>
