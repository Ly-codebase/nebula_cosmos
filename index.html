<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nebula Cosmos Â· æ˜Ÿäº‘çŸ¥è¯†å®‡å®™ v3.6</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* æ ·å¼å®Œå…¨ä¿ç•™ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #020617;
      background-image: radial-gradient(circle at 20% 30%, rgba(30, 58, 138, 0.3) 0%, transparent 50%), radial-gradient(circle at 80% 70%, rgba(88, 28, 135, 0.2) 0%, transparent 50%), radial-gradient(circle at 50% 50%, rgba(15, 23, 42, 1) 0%, #020617 100%);
      background-attachment: fixed; color: #f1f5f9; font-family: 'Inter', 'PingFang SC', sans-serif;
      height: 100vh; overflow: hidden; display: flex; padding: 25px;
    }
    .container { display: flex; gap: 25px; width: 100%; height: 100%; }
    .sidebar { width: 420px; display: flex; flex-direction: column; gap: 15px; height: 100%; }
    .panel { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.4); }
    .scroll-form { flex: 1; overflow-y: auto; }
    .scroll-form::-webkit-scrollbar { width: 4px; }
    .scroll-form::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    h2 { font-size: 1rem; margin-bottom: 12px; color: #38bdf8; font-weight: 500; }
    .form-group { margin-bottom: 12px; }
    label { display: block; font-size: 0.75rem; margin-bottom: 4px; color: #94a3b8; }
    input, select, textarea { width: 100%; background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); color: #fff; padding: 10px; border-radius: 10px; outline: none; font-size: 0.85rem; }
    
    .cloud-box { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; max-height: 80px; overflow-y: auto; }
    .pill { font-size: 0.65rem; background: rgba(56, 189, 248, 0.1); color: #7dd3fc; padding: 3px 8px; border-radius: 12px; cursor: pointer; border: 1px solid rgba(56, 189, 248, 0.2); }
    
    .btn { padding: 10px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; transition: 0.3s; font-size: 0.85rem; }
    .btn-main { background: linear-gradient(135deg, #38bdf8, #2563eb); color: white; width: 100%; margin-top: 5px; }
    .btn-danger { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); width: 100%; margin-top: 10px; }
    
    .graph-view { flex: 1; position: relative; border-radius: 30px; overflow: hidden; }
    #canvas { width: 100%; height: 100%; cursor: grab; }
    .link { stroke-opacity: 0.25; stroke-width: 1.5px; transition: stroke-opacity 0.4s; }
    .node { transition: opacity 0.4s; }
    .node text { fill: #cbd5e1; font-size: 11px; pointer-events: none; text-anchor: middle; }
    
    /* æœç´¢åŒ¹é…ä¸­å¿ƒå…‰æ™• */
    .node.center-match circle { stroke: #fff; stroke-width: 2px; filter: drop-shadow(0 0 10px #38bdf8); }

    #detail-panel {
      position: absolute; right: -360px; top: 20px; width: 330px; bottom: 20px;
      background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(30px);
      border: 1px solid rgba(56, 189, 248, 0.3); border-radius: 24px; padding: 30px;
      transition: 0.6s cubic-bezier(0.22, 1, 0.36, 1); z-index: 1000;
    }
    #detail-panel.active { right: 20px; }
  </style>
</head>
<body>

  <div class="container">
    <div class="sidebar">
      <div class="panel scroll-form">
        <h2>ğŸ“— å½•å…¥æ–°çŸ¥è¯†</h2>
        <form id="atlasForm">
          <div class="form-group"><label>ä¹¦å</label><input type="text" id="title" required></div>
          <div style="display:flex; gap:10px">
            <div class="form-group" style="flex:1"><label>ä½œè€…</label><input type="text" id="author" required></div>
            <div class="form-group" style="flex:1"><label>å›½å®¶</label><input type="text" id="country"></div>
          </div>
          <div class="form-group">
            <label>ä¸»é¢˜ç»´åº¦ (å¤šä¸ªç”¨ / åˆ†éš”)</label>
            <input type="text" id="theme" required placeholder="å“²å­¦ / ç¤¾ä¼šå­¦">
            <div class="cloud-box" id="themeCloud"></div>
          </div>
          <div class="form-group">
            <label>æ ‡ç­¾ (å¤šä¸ªç”¨ / åˆ†éš”)</label>
            <input type="text" id="keywords" placeholder="ç»å…¸ / å¿…è¯»">
            <div class="cloud-box" id="tagCloud"></div>
          </div>
          <div style="display:flex; gap:10px">
            <div class="form-group" style="flex:1"><label>å®Œè¯»æœˆä»½</label><input type="month" id="readMonth"></div>
          </div>
          <div class="form-group"><label>ç¬”è®°</label><textarea id="notes" rows="2"></textarea></div>
          <button type="submit" class="btn btn-main">æ·»åŠ åˆ°çŸ¥è¯†å®‡å®™</button>
        </form>
      </div>

      <div class="panel">
        <h2>ğŸ” æ£€ç´¢ä¸å…³è”é«˜äº®</h2>
        <div style="display:flex; gap:8px; margin-bottom:10px;">
          <input type="text" id="searchInput" placeholder="æœç´¢æ˜Ÿçƒ...">
          <button class="btn" style="background:#334155; color:white;" id="searchBtn">æœç´¢</button>
          <button class="btn" style="background:rgba(255,255,255,0.1); color:white;" id="resetBtn">è¿˜åŸ</button>
        </div>
        <div class="form-group">
          <label>å¹´ä»½ç­›é€‰</label>
          <select id="yearFilter"><option value="all">æ˜¾ç¤ºå…¨éƒ¨</option></select>
        </div>
        <div id="searchList" style="max-height:50px; overflow-y:auto; font-size:0.75rem; color:#38bdf8;"></div>
      </div>

      <div class="panel">
        <div style="display:flex; gap: 8px;">
          <button class="btn" style="flex:1; background:rgba(255,255,255,0.05); color:#94a3b8; border:1px solid rgba(255,255,255,0.1)" id="exportBtn">å¯¼å‡º CSV</button>
          <button class="btn" style="flex:1; background:rgba(255,255,255,0.05); color:#94a3b8; border:1px solid rgba(255,255,255,0.1)" id="importBtn">å¯¼å…¥ CSV</button>
        </div>
        <button class="btn btn-danger" id="clearAllBtn" style="width:100%">â˜¢ æ¸…ç©ºå®‡å®™æ•°æ®</button>
        <input type="file" id="fileInput" accept=".csv" style="display:none">
      </div>
    </div>

    <div class="graph-view">
      <svg id="canvas">
        <defs>
          <radialGradient id="grad-book" cx="30%" cy="30%" r="50%"><stop offset="0%" stop-color="#7dd3fc" /><stop offset="100%" stop-color="#0369a1" /></radialGradient>
          <radialGradient id="grad-author" cx="30%" cy="30%" r="50%"><stop offset="0%" stop-color="#fcd34d" /><stop offset="100%" stop-color="#b45309" /></radialGradient>
          <radialGradient id="grad-country" cx="30%" cy="30%" r="50%"><stop offset="0%" stop-color="#6ee7b7" /><stop offset="100%" stop-color="#065f46" /></radialGradient>
          <radialGradient id="grad-theme" cx="30%" cy="30%" r="50%"><stop offset="0%" stop-color="#d8b4fe" /><stop offset="100%" stop-color="#7e22ce" /></radialGradient>
          <radialGradient id="grad-tag" cx="30%" cy="30%" r="50%"><stop offset="0%" stop-color="#94a3b8" /><stop offset="100%" stop-color="#334155" /></radialGradient>
          <filter id="planet-glow" x="-100%" y="-100%" width="300%" height="300%"><feGaussianBlur stdDeviation="6" result="blur" /><feComposite in="SourceGraphic" in2="blur" operator="over" /></filter>
        </defs>
      </svg>
      <div id="detail-panel">
        <div style="text-align:right; cursor:pointer; color:#94a3b8" onclick="this.parentElement.classList.remove('active')">å…³é—­ âœ•</div>
        <h3 id="det-title" style="color:#38bdf8; margin: 20px 0; font-size: 1.2rem;"></h3>
        <div id="det-content" style="font-size:0.9rem; line-height:1.7; color:#e2e8f0;"></div>
      </div>
    </div>
  </div>

  <script>
    const store = {
      items: JSON.parse(localStorage.getItem('nebula_v3_data')) || [],
      save() { localStorage.setItem('nebula_v3_data', JSON.stringify(this.items)); },
      
      splitStr(str) {
        if(!str) return [];
        return str.split(/[\/ï¼]/).map(s => s.trim()).filter(s => s !== "");
      },

      getNodes() {
        const nodes = [];
        this.items.forEach(d => {
          if(!nodes.find(n => n.id === d.title)) nodes.push({id: d.title, label: d.title, type: 'book', raw: d});
          if(!nodes.find(n => n.id === d.author)) nodes.push({id: d.author, label: d.author, type: 'author'});
          if(d.country && !nodes.find(n => n.id === d.country)) nodes.push({id: d.country, label: d.country, type: 'country'});
          this.splitStr(d.theme).forEach(t => {
            const tid = 'theme-' + t;
            if(!nodes.find(n => n.id === tid)) nodes.push({id: tid, label: t, type: 'theme'});
          });
          this.splitStr(d.keywords).forEach(k => {
            const kid = 'tag-' + k;
            if(!nodes.find(n => n.id === kid)) nodes.push({id: kid, label: k, type: 'tag'});
          });
        });
        return nodes;
      },
      getLinks() {
        const links = [];
        this.items.forEach(d => {
          links.push({source: d.title, target: d.author, color: '#0ea5e9'});
          if(d.country) links.push({source: d.author, target: d.country, color: '#10b981'});
          this.splitStr(d.theme).forEach(t => links.push({source: d.title, target: 'theme-' + t, color: '#a855f7'}));
          this.splitStr(d.keywords).forEach(k => links.push({source: d.title, target: 'tag-' + k, color: '#64748b'}));
        });
        return links;
      }
    };

    const svg = d3.select("#canvas");
    const container = svg.append("g");
    const zoom = d3.zoom().scaleExtent([0.1, 4]).on("zoom", (e) => container.attr("transform", e.transform));
    svg.call(zoom);

    let simulation, nodeElements, linkElements;

    function render() {
      container.selectAll("*").remove();
      const nodes = store.getNodes();
      const links = store.getLinks();
      const width = svg.node().clientWidth, height = svg.node().clientHeight;

      simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(120))
        .force("charge", d3.forceManyBody().strength(-550))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("x", d3.forceX(width / 2).strength(0.08))
        .force("y", d3.forceY(height / 2).strength(0.08))
        .force("collide", d3.forceCollide(60));

      linkElements = container.append("g").selectAll("line").data(links).enter()
        .append("line").attr("class", "link").attr("stroke", d => d.color);

      nodeElements = container.append("g").selectAll("g").data(nodes).enter()
        .append("g").attr("class", "node")
        .on("click", (e, d) => showDetail(d))
        .call(d3.drag()
          .on("start", (e, d) => { if (!e.active) simulation.alphaTarget(0.2).restart(); d.fx = d.x; d.fy = d.y; })
          .on("drag", (e, d) => { d.fx = e.x; d.fy = e.y; })
          .on("end", (e, d) => { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }));

      nodeElements.append("circle")
        .attr("r", d => ({book:24, author:18, country:32, theme:15, tag:12}[d.type]))
        .attr("fill", d => `url(#grad-${d.type})`)
        .style("filter", "url(#planet-glow)");

      nodeElements.append("text").attr("dy", 42).text(d => d.label);

      simulation.on("tick", () => {
        const time = Date.now() * 0.0015;
        nodes.forEach((d, i) => { d.x += Math.cos(time + i) * 0.12; d.y += Math.sin(time + i) * 0.12; });
        linkElements.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        nodeElements.attr("transform", d => `translate(${d.x},${d.y})`);
      });

      updateUIControls(nodes);
    }

    function updateUIControls(nodes) {
      const themeList = [...new Set(nodes.filter(n => n.type === 'theme').map(n => n.label))];
      document.getElementById('themeCloud').innerHTML = themeList.map(t => `<span class="pill" onclick="quickFill('theme','${t}')">${t}</span>`).join('');
      const tagList = [...new Set(nodes.filter(n => n.type === 'tag').map(n => n.label))];
      document.getElementById('tagCloud').innerHTML = tagList.map(t => `<span class="pill" onclick="quickFill('keywords','${t}')">${t}</span>`).join('');
      const years = [...new Set(store.items.map(i => i.readMonth?.split('-')[0]).filter(y => y))].sort().reverse();
      document.getElementById('yearFilter').innerHTML = '<option value="all">æ˜¾ç¤ºå…¨éƒ¨</option>' + years.map(y => `<option value="${y}">${y} å¹´</option>`).join('');
    }

    window.quickFill = (id, val) => {
      const el = document.getElementById(id);
      const curr = el.value.trim();
      if(!curr) el.value = val;
      else if(!curr.split('/').map(s=>s.trim()).includes(val)) el.value = curr + ' / ' + val;
    };

    // --- æ ¸å¿ƒä¿®æ”¹ï¼šå…³è”é«˜äº®æ£€ç´¢é€»è¾‘ ---
    document.getElementById('searchBtn').onclick = () => {
      const val = document.getElementById('searchInput').value.trim().toLowerCase();
      if(!val) return;

      const matchedNodeIds = new Set();
      const relatedNodeIds = new Set();
      const relatedLinkIds = new Set();

      // 1. æ‰¾åˆ°ç›´æ¥åŒ¹é…çš„ä¸­å¿ƒèŠ‚ç‚¹
      const nodes = store.getNodes();
      nodes.forEach(n => {
        if(n.label.toLowerCase().includes(val)) matchedNodeIds.add(n.id);
      });

      // 2. æ‰¾åˆ°æ‰€æœ‰å…³è”çš„èŠ‚ç‚¹å’Œçº¿
      const links = store.getLinks();
      links.forEach(l => {
        const s = l.source.id || l.source;
        const t = l.target.id || l.target;
        if(matchedNodeIds.has(s) || matchedNodeIds.has(t)) {
          relatedNodeIds.add(s);
          relatedNodeIds.add(t);
          relatedLinkIds.add(l); // æ ‡è®°æ­¤è¿çº¿éœ€è¦é«˜äº®
        }
      });

      // 3. æ‰§è¡Œè§†è§‰é«˜äº®
      nodeElements.style("opacity", d => (matchedNodeIds.has(d.id) || relatedNodeIds.has(d.id)) ? 1 : 0.05)
                  .classed("center-match", d => matchedNodeIds.has(d.id));
      
      linkElements.style("stroke-opacity", d => {
          const s = d.source.id || d.source;
          const t = d.target.id || d.target;
          return (matchedNodeIds.has(s) || matchedNodeIds.has(t)) ? 0.6 : 0.02;
      }).style("stroke-width", d => {
          const s = d.source.id || d.source;
          const t = d.target.id || d.target;
          return (matchedNodeIds.has(s) || matchedNodeIds.has(t)) ? "3px" : "1.5px";
      });

      // 4. æ›´æ–°æœç´¢ç»“æœåˆ—è¡¨
      const results = nodes.filter(n => matchedNodeIds.has(n.id));
      document.getElementById('searchList').innerHTML = results.map(n => `<div onclick="focusNode('${n.id}')" style="cursor:pointer; padding:3px;">âœ¨ ${n.label}</div>`).join('');
    };

    document.getElementById('resetBtn').onclick = () => {
      document.getElementById('searchInput').value = "";
      document.getElementById('searchList').innerHTML = "";
      nodeElements.style("opacity", 1).classed("center-match", false);
      linkElements.style("stroke-opacity", 0.25).style("stroke-width", "1.5px");
      svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
    };

    window.focusNode = (id) => {
      const target = nodeElements.filter(d => d.id === id).datum();
      if(target) {
        const t = d3.zoomIdentity.translate(svg.node().clientWidth/2, svg.node().clientHeight/2).scale(1.6).translate(-target.x, -target.y);
        svg.transition().duration(1000).call(zoom.transform, t);
        showDetail(target);
      }
    };

    function showDetail(d) {
      const panel = document.getElementById('detail-panel');
      panel.classList.add('active');
      document.getElementById('det-title').innerText = d.label;
      const content = document.getElementById('det-content');
      if(d.type === 'book') {
        content.innerHTML = `<p>ğŸ“… <b>å®Œè¯»ï¼š</b>${d.raw.readMonth}</p><p>ğŸ‘¤ <b>ä½œè€…ï¼š</b>${d.raw.author}</p><p>ğŸ’  <b>ä¸»é¢˜ï¼š</b>${d.raw.theme}</p><p>âœ¨ <b>æ ‡ç­¾ï¼š</b>${d.raw.keywords}</p><br><p><b>ç¬”è®°ï¼š</b>${d.raw.notes || 'æ— '}</p>`;
      } else {
        content.innerHTML = `<p style="color:#94a3b8">èŠ‚ç‚¹ç±»å‹: <b>${d.type}</b></p>`;
      }
    }

    document.getElementById('atlasForm').onsubmit = (e) => {
      e.preventDefault();
      store.items.push({
        title: document.getElementById('title').value, author: document.getElementById('author').value,
        country: document.getElementById('country').value, theme: document.getElementById('theme').value,
        readMonth: document.getElementById('readMonth').value, keywords: document.getElementById('keywords').value,
        notes: document.getElementById('notes').value
      });
      store.save(); render(); e.target.reset();
    };

    document.getElementById('clearAllBtn').onclick = () => { if(confirm('â˜¢ ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ')) { store.items = []; store.save(); render(); } };
    document.getElementById('exportBtn').onclick = () => {
      let csv = "\ufeffä¹¦å,ä½œè€…,å›½å®¶,å®Œè¯»æœˆä»½,ä¸»é¢˜,å…³é”®è¯,ç¬”è®°\n";
      store.items.forEach(i => csv += `"${i.title}","${i.author}","${i.country}","${i.readMonth}","${i.theme}","${i.keywords}","${i.notes}"\n`);
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "My_Reading_Cosmos.csv"; a.click();
    };
    document.getElementById('importBtn').onclick = () => document.getElementById('fileInput').click();
    document.getElementById('fileInput').onchange = (e) => {
      const reader = new FileReader();
      reader.onload = (ev) => {
        const lines = ev.target.result.split('\n').slice(1);
        lines.forEach(l => {
          if(!l.trim()) return;
          const p = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s?.replace(/^"|"$/g, '').trim());
          if(p[0]) store.items.push({title:p[0], author:p[1]||'', country:p[2]||'', readMonth:p[3]||'', theme:p[4]||'', keywords:p[5]||'', notes:p[6]||''});
        });
        store.save(); render();
      };
      reader.readAsText(e.target.files[0]);
    };

    render();
    window.onresize = render;
  </script>
</body>
</html>